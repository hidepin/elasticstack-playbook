---
# file: roles/kibana/tasks/main.yml
- name: upgrade kibana
  include: upgrade.yml
  tags:
    - upgrade

- name: kibana install
  package:
    name: kibana
    state: latest

- name: kibana plugin install
  shell: |
    "/usr/share/elasticsearch/bin/kibana-plugin install --batch {{ item.plugin }}"
  args:
    creates: "{{ item.creates }}"
  notify: kibana restart
  with_items: "{{ kibana_plugins }}"

- block:
  - name: kibana config setting
    template:
      src: kibana.yml.j2
      dest: /etc/kibana/kibana.yml
      owner: root
      group: root
      mode: 0664
      backup: yes
    register: is_kibana_setting
    notify: kibana restart

  always:
  - name: elk-common backup settings
    include: backup.yml
    with_flattened:
      - "{{ is_kibana_setting|default() }}"
    loop_control:
      loop_var: backup_item

- name: enable kibana service
  service:
    name: kibana
    state: started
    enabled: yes
    daemon_reload: yes
